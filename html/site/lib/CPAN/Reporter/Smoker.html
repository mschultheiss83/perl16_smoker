<?xml version="1.0" ?>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<!-- saved from url=(0017)http://localhost/ -->
<script language="JavaScript" src="../../../../displayToc.js"></script>
<script language="JavaScript" src="../../../../tocParas.js"></script>
<script language="JavaScript" src="../../../../tocTab.js"></script>
<link rel="stylesheet" type="text/css" href="../../../../scineplex.css">
<title></title>
<link rel="stylesheet" href="../../../../Active.css" type="text/css" />
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:" />
</head>

<body>



<ul id="index">
  <li><a href="#NAME">NAME</a></li>
  <li><a href="#VERSION">VERSION</a></li>
  <li><a href="#SYNOPSIS">SYNOPSIS</a></li>
  <li><a href="#DESCRIPTION">DESCRIPTION</a>
    <ul>
      <li><a href="#WARNING----smoke-testing-is-risky">WARNING -- smoke testing is risky</a></li>
    </ul>
  </li>
  <li><a href="#USAGE">USAGE</a>
    <ul>
      <li><a href="#start-"><code>start()</code></a></li>
    </ul>
  </li>
  <li><a href="#HINTS">HINTS</a>
    <ul>
      <li><a href="#Selection-of-distributions-to-test">Selection of distributions to test</a></li>
      <li><a href="#Skipping-additional-distributions">Skipping additional distributions</a></li>
      <li><a href="#Using-a-local-CPAN::Mini-mirror">Using a local CPAN::Mini mirror</a></li>
      <li><a href="#Timing-out-hanging-tests">Timing out hanging tests</a></li>
      <li><a href="#Avoiding-repetitive-prerequisite-testing">Avoiding repetitive prerequisite testing</a></li>
      <li><a href="#Avoiding-repetitive-prerequisite-builds-EXPERIMENTAL-">Avoiding repetitive prerequisite builds (EXPERIMENTAL)</a></li>
      <li><a href="#Stopping-early-if-a-prerequisite-fails">Stopping early if a prerequisite fails</a></li>
      <li><a href="#CPAN-cache-bloat">CPAN cache bloat</a></li>
      <li><a href="#CPAN-verbosity">CPAN verbosity</a></li>
      <li><a href="#Saving-reports-to-files-instead-of-sending-directly">Saving reports to files instead of sending directly</a></li>
    </ul>
  </li>
  <li><a href="#ENVIRONMENT">ENVIRONMENT</a></li>
  <li><a href="#BUGS">BUGS</a></li>
  <li><a href="#SEE-ALSO">SEE ALSO</a></li>
  <li><a href="#SUPPORT">SUPPORT</a>
    <ul>
      <li><a href="#Bugs-Feature-Requests">Bugs / Feature Requests</a></li>
      <li><a href="#Source-Code">Source Code</a></li>
    </ul>
  </li>
  <li><a href="#AUTHOR">AUTHOR</a></li>
  <li><a href="#COPYRIGHT-AND-LICENSE">COPYRIGHT AND LICENSE</a></li>
</ul>

<h1 id="NAME">NAME</h1>

<p>CPAN::Reporter::Smoker - Turnkey CPAN Testers smoking</p>

<h1 id="VERSION">VERSION</h1>

<p>version 0.24</p>

<h1 id="SYNOPSIS">SYNOPSIS</h1>

<pre><code>     $ perl -MCPAN::Reporter::Smoker -e start</code></pre>

<h1 id="DESCRIPTION">DESCRIPTION</h1>

<p>Rudimentary smoke tester for CPAN Testers, built upon <a href="../../../../site/lib/CPAN/Reporter.html">CPAN::Reporter</a>. Use at your own risk. It requires a recent version of CPAN::Reporter to run.</p>

<p>Currently, CPAN::Reporter::Smoker requires zero independent configuration; instead it uses configuration settings from CPAN.pm and CPAN::Reporter.</p>

<p>Once started, it retrieves a list of distributions from the configured CPAN mirror and begins testing them in reverse order of upload. It will skip any distribution which has already had a report sent by CPAN::Reporter.</p>

<p>Features (or bugs, depending on your point of view):</p>

<ul>

<li><p>No configuration needed</p>

</li>
<li><p>Tests each distribution as a separate CPAN process -- each distribution has prerequisites like build_requires satisfied from scratch</p>

</li>
<li><p>Automatically checks for new distributions every twelve hours or as otherwise specified</p>

</li>
<li><p>Continues until interrupted with CTRL-C</p>

</li>
<li><p>Checks CPAN.pm &quot;distroprefs&quot; to see if distributions should be skipped (before handing off to CPAN)</p>

</li>
</ul>

<p>Current limitations:</p>

<ul>

<li><p>Does not attempt to retest distributions that had reports discarded because of prerequisites that could not be satisfied</p>

</li>
</ul>

<h2 id="WARNING----smoke-testing-is-risky">WARNING -- smoke testing is risky</h2>

<p>Smoke testing will download and run programs that other people have uploaded to CPAN. These programs could do <b>anything</b> to your system, including deleting everything on it. Do not run CPAN::Reporter::Smoker unless you are prepared to take these risks.</p>

<h1 id="USAGE">USAGE</h1>

<h2 id="start-"><code>start()</code></h2>

<p>Starts smoke testing using defaults already in CPAN::Config and CPAN::Reporter&#39;s .cpanreporter directory. Runs until all distributions are tested or the process is halted with CTRL-C or otherwise killed.</p>

<p><code>start()</code> supports several optional arguments:</p>

<ul>

<li><p><code>clean_cache_after</code> -- number of distributions that will be tested before checking to see if the CPAN build cache needs to be cleaned up (not including any prerequisites tested). Must be a positive integer. Defaults to 100</p>

</li>
<li><p><code>list</code> -- if provided, this list of distributions will be tested instead of all of CPAN. May be a reference to an array of distribution names or may be a filename containing one distribution name per line. Distribution names must be of the form &#39;AUTHOR/Dist-Name-0.00.tar.gz&#39;</p>

</li>
<li><p><code>restart_delay</code> -- number of seconds that must elapse before restarting smoke testing. This will reload indices to search for new distributions and restart testing from the most recent distribution. Must be a positive integer; Defaults to 43200 seconds (12 hours)</p>

</li>
<li><p><code>set_term_title</code> -- toggle for whether the terminal titlebar will be updated with the distribution being smoke tested and the starting time of the test. Helps determine if a test is hung and which distribution might be responsible. Valid values are 0 or 1. Defaults to 1</p>

</li>
<li><p><code>status_file</code> -- during testing, the name of the distribution under test and a timestamp are written to this file. The file is removed after the test is complete. This helps identify a problem distribution if testing hangs or crashes the computer. If the argument includes a path, all directories to the file must exist. Defaults to <code>smoker-status-$$.txt</code> in File::Spec-&gt;tmpdir.</p>

</li>
<li><p><code>install</code> -- toggle for whether the distribution should be installed after successful testing. Can be useful to avoid prerequisite re-building and growing PERL5LIB for the cost of disk space used for installed modules. Valid values are 0 or 1. Defaults to 0</p>

</li>
<li><p><code>reverse</code> -- toggle the order in which releases are tested. When set to 1, testing starts from the older release not the most recent one (or the last distribution if --list is provided). Valid values are 0 or 1. Defaults to 0</p>

</li>
<li><p><code>force_trust</code> -- toggle whether to override CPAN&#39;s <code>trust_test_report_history</code> option. When set to 1, <code>trust_test_report_history</code> is set to 1. When set to 0, <code>trust_test_report_history</code> is left alone and whatever the user has configured for their CPAN client is used. Valid values are 0 or 1. Defaults to 0</p>

</li>
</ul>

<h1 id="HINTS">HINTS</h1>

<h2 id="Selection-of-distributions-to-test">Selection of distributions to test</h2>

<p>Only the most recently uploaded developer and normal releases will be tested, and only if the developer release is newer than the regular release indexed by PAUSE.</p>

<p>For example, if Foo-Bar-0.01, Foo-Bar-0.02, Foo-Bar-0.03_01 and Foo-Bar-0.03_02 are on CPAN, only Foo-Bar-0.02 and Foo-Bar-0.03_02 will be tested, and in reverse order of when they were uploaded. Once Foo-Bar-0.04 is released and indexed, Foo-Bar-0.03_02 will not longer be tested.</p>

<p>To avoid testing script or other tarballs, developer distributions included must have a base distribution name that resembles a distribution tarball already indexed by PAUSE. If the first upload of distribution to PAUSE is a developer release -- Baz-Bam-0.00_01.tar.gz -- it will not be tested as there is no indexed Baz-Bam appearing in CPAN&#39;s 02packages.details.txt file.</p>

<p>Unauthorized tarballs are treated like developer releases and will be tested if they resemble an indexed distribution and are newer than the indexed tarball.</p>

<p>Perl, parrot, kurila, Pugs and similar distributions will not be tested. The skip list is based on CPAN::Mini and matches as follows:</p>

<pre><code>     <span class="string">qr{(?:
           /(?:emb|syb|bio)?perl-\d
         | /(?:parrot|ponie|kurila|Perl6-Pugs)-\d
         | /perl-?5\.004
         | /perl_mlb\.zip
     )}xi</span><span class="operator">,</span>
</code></pre>

<p>Bundles and mod_perl distributions will also not be tested, though mod_perl is likely to be requested as a dependency by many modules. See the next section for how to tell CPAN.pm not to test certain dependencies.</p>

<h2 id="Skipping-additional-distributions">Skipping additional distributions</h2>

<p>If certain distributions hang, crash or otherwise cause trouble, you can use CPAN&#39;s &quot;distroprefs&quot; system to disable them. If a distribution is disabled, it won&#39;t be built or tested. If a distribution&#39;s dependency is disabled, a failing test is just discarded.</p>

<p>The first step is configuring a directory for distroprefs files:</p>

<pre><code>     $ cpan
     cpan&gt; o conf init prefs_dir
     cpan&gt; o conf commit</code></pre>

<p>Next, ensure that either the <a href="../../../../lib/TAP/Parser/Result/YAML.html">YAML</a> or <a>YAML::Syck</a> module is installed. (YAML::Syck is faster). Then create a file in the <code>prefs_dir</code> directory to hold the list of distributions to disable, e.g. call it <code>disabled.yml</code></p>

<p>In that file, you can add blocks of YAML code to disable distributions. The match criteria &quot;distribution&quot; is a regex that matches against the canonical name of a distribution, e.g. <code>AUTHOR/Foo-Bar-3.14.tar.gz</code>.</p>

<p>Here is a sample file to show you some syntax (don&#39;t actually use these, though):</p>

<pre><code>     ---
     comment: &quot;Tests take too long&quot;
     match:
         distribution: &quot;^DAGOLDEN/CPAN-Reporter-\d&quot;
     disabled: 1
     ---
     comment: &quot;Skip Win32 distributions&quot;
     match:
         distribution: &quot;/Win32&quot;
     disabled: 1
     ---
     comment: &quot;Skip distributions by Andy Lester&quot;
     match:
         distribution: &quot;^PETDANCE&quot;
     disabled: 1</code></pre>

<p>Please note that disabling distributions like this will also disable them for normal, non-smoke usage of CPAN.pm.</p>

<p>One distribution that I would recommend either installing up front or else disabling with distroprefs is mod_perl, as it is a common requirement for many Apache:: modules but does not (easily) build and test under automation.</p>

<pre><code>     ---
     comment: &quot;Don&#39;t build mod_perl if required by some other module&quot;
     match:
         distribution: &quot;/mod_perl-\d&quot;
     disabled: 1</code></pre>

<p>Distroprefs are more powerful than this -- they can be used to automate responses to prompts in distributions, set environment variables, specify additional dependencies and so on. Read the docs for CPAN.pm for more and look in the &quot;distroprefs&quot; directory in the CPAN distribution tarball for examples.</p>

<h2 id="Using-a-local-CPAN::Mini-mirror">Using a local CPAN::Mini mirror</h2>

<p>Because distributions must be retrieved from a CPAN mirror, the smoker may cause heavy network load and will reptitively download common build prerequisites.</p>

<p>An alternative is to use <a>CPAN::Mini</a> to create a local CPAN mirror and to point CPAN&#39;s <code>urllist</code> to the local mirror.</p>

<pre><code>     $ cpan
     cpan&gt; o conf urllist unshift file:///path/to/minicpan
     cpan&gt; o conf commit</code></pre>

<p>However, CPAN::Reporter::Smoker needs the <code>find-ls.gz</code> file, which CPAN::Mini does not mirror by default. Add it to a .minicpanrc file in your home directory to include it in your local CPAN mirror.</p>

<pre><code>     also_mirror: indices/find-ls.gz</code></pre>

<p>Note that CPAN::Mini does not mirror developer versions. Therefore, a live, network CPAN Mirror will be needed in the urllist to retrieve these.</p>

<p>Note that CPAN requires the LWP module to be installed to use a local CPAN mirror.</p>

<p>Alternatively, you might experiment with the alpha-quality release of <a>CPAN::Mini::Devel</a>, which subclasses CPAN::Mini to retrieve developer distributions (and find-ls.gz) using the same logic as CPAN::Reporter::Smoker.</p>

<h2 id="Timing-out-hanging-tests">Timing out hanging tests</h2>

<p>CPAN::Reporter (since 1.08) supports a &#39;command_timeout&#39; configuration option. Set this option in the CPAN::Reporter configuration file to time out tests that hang up or get stuck at a prompt. Set it to a high-value to avoid timing out a lengthy tests that are still running -- 1000 or more seconds is probably enough.</p>

<p>Warning -- on Win32, terminating processes via the command_timeout is equivalent to SIGKILL and could cause system instability or later deadlocks</p>

<p>This option is still considered experimental.</p>

<h2 id="Avoiding-repetitive-prerequisite-testing">Avoiding repetitive prerequisite testing</h2>

<p>Because CPAN::Reporter::Smoker satisfies all requirements from scratch, common dependencies (e.g. Class::Accessor) will be unpacked, built and tested repeatedly.</p>

<p>As of version 1.92_56, CPAN supports the <code>trust_test_report_history</code> config option. When set, CPAN will check the last test report for a distribution. If one is found, the results of that test are used instead of running tests again.</p>

<pre><code>     $ cpan
     cpan&gt; o conf init trust_test_report_history
     cpan&gt; o conf commit</code></pre>

<h2 id="Avoiding-repetitive-prerequisite-builds-EXPERIMENTAL-">Avoiding repetitive prerequisite builds (EXPERIMENTAL)</h2>

<p>CPAN has a <code>build_dir_reuse</code> config option. When set (and if a YAML module is installed and configured), CPAN will attempt to make build directories persistent. This has the potential to save substantial time and space during smoke testing. CPAN::Reporter::Smoker will recognize if this option is set and make adjustments to the test process to keep PERL5LIB from growing uncontrollably as the number of persistent directories increases.</p>

<p><b>NOTE:</b> Support for <code>build_dir_reuse</code> is highly experimental. Wait for at least CPAN version 1.92_62 before trying this option.</p>

<pre><code>     $ cpan
     cpan&gt; o conf init build_dir_reuse
     cpan&gt; o conf commit</code></pre>

<h2 id="Stopping-early-if-a-prerequisite-fails">Stopping early if a prerequisite fails</h2>

<p>Normally, CPAN.pm continues testing a distribution even if a prequisite fails to build or fails testing. Some distributions may pass their tests even without a listed prerequisite, but most just fail (and CPAN::Reporter discards failures if prerequisites are not met).</p>

<p>As of version 1.92_57, CPAN supports the <code>halt_on_failure</code> config option. When set, a prerequisite failure stops further processing.</p>

<pre><code>     $ cpan
     cpan&gt; o conf init halt_on_failure
     cpan&gt; o conf commit</code></pre>

<p>However, a disadvantage of halting early is that no DISCARD grade is recorded in the history. The next time CPAN::Reporter::Smoker runs, the distribution will be tested again from scratch. It may be better to let all prerequisites finish so the distribution can fail its test and be flagged with DISCARD so it will be skipped in the future.</p>

<h2 id="CPAN-cache-bloat">CPAN cache bloat</h2>

<p>CPAN will use a lot of scratch space to download, build and test modules. Use CPAN&#39;s built-in cache management configuration to let it purge the cache periodically if you don&#39;t want to do this manually. When configured, the cache will be purged on start and after a certain number of distributions have been tested as determined by the <code>clean_cache_after</code> option for the <code>start()</code> function.</p>

<pre><code>     $ cpan
     cpan&gt; o conf init build_cache scan_cache
     cpan&gt; o conf commit</code></pre>

<h2 id="CPAN-verbosity">CPAN verbosity</h2>

<p>Recent versions of CPAN are verbose by default, but include some lesser known configuration settings to minimize this for untarring distributions and for loading support modules. Setting the verbosity for these to &#39;none&#39; will minimize some of the clutter to the screen as distributions are tested.</p>

<pre><code>     $ cpan
     cpan&gt; o conf init /verbosity/
     cpan&gt; o conf commit</code></pre>

<h2 id="Saving-reports-to-files-instead-of-sending-directly">Saving reports to files instead of sending directly</h2>

<p>In some cases, such as when smoke testing using a development or prerelease toolchain module like Test-Harness, it may be prefereable to save reports to files in a directory for review prior to submitting them. To do this, manually set the <code>transport</code> option in your CPAN::Reporter config file to use the <a href="../../../../site/lib/Test/Reporter/Transport/File.html">Test::Reporter::Transport::File</a> transport.</p>

<pre><code>     transport=File /path/to/directory</code></pre>

<p>After review, send saved reports using Test::Reporter:</p>

<pre><code>     Test::Reporter-&gt;new()-&gt;read($filename)-&gt;send()</code></pre>

<h1 id="ENVIRONMENT">ENVIRONMENT</h1>

<p>Automatically sets the following environment variables to true values while running:</p>

<ul>

<li><p><code>AUTOMATED_TESTING</code> -- signal that tests are being run by an automated smoke testing program (i.e. don&#39;t expect interactivity)</p>

</li>
<li><p><code>PERL_MM_USE_DEFAULT</code> -- accept <a href="../../../../lib/ExtUtils/MakeMaker.html">ExtUtils::MakeMaker</a> prompt() defaults</p>

</li>
<li><p><code>PERL_EXTUTILS_AUTOINSTALL</code> -- set to &#39;--defaultdeps&#39; for default dependencies</p>

</li>
</ul>

<p>The following environment variables, if set, will modify the behavior of CPAN::Reporter::Smoker. Generally, they are only required during the testing of CPAN::Reporter::Smoker</p>

<ul>

<li><p><code>PERL_CR_SMOKER_RUNONCE</code> -- if true, <code>start()</code> will exit after all distributions are tested instead of sleeping for the <code>restart_delay</code> and then continuing</p>

</li>
<li><p><code>PERL_CR_SMOKER_SHORTCUT</code> -- if true, <code>start()</code> will process arguments (if any) but will return before starting smoke testing; used for testing argument handling by <code>start()</code></p>

</li>
</ul>

<h1 id="BUGS">BUGS</h1>

<p>Please report any bugs or feature using the CPAN Request Tracker. Bugs can be submitted through the web interface at <a href="http://rt.cpan.org/Dist/Display.html?Queue=CPAN-Reporter-Smoker">http://rt.cpan.org/Dist/Display.html?Queue=CPAN-Reporter-Smoker</a></p>

<p>When submitting a bug or request, please include a test-file or a patch to an existing test-file that illustrates the bug or desired feature.</p>

<h1 id="SEE-ALSO">SEE ALSO</h1>

<ul>

<li><p><a href="../../../../lib/CPAN.html">CPAN</a></p>

</li>
<li><p><a href="../../../../site/lib/CPAN/Reporter.html">CPAN::Reporter</a></p>

</li>
<li><p><a>CPAN::Testers</a></p>

</li>
<li><p><a>CPAN::Mini</a></p>

</li>
<li><p><a>CPAN::Mini::Devel</a></p>

</li>
</ul>

<h1 id="SUPPORT">SUPPORT</h1>

<h2 id="Bugs-Feature-Requests">Bugs / Feature Requests</h2>

<p>Please report any bugs or feature requests by email to <code>bug-cpan-reporter-smoker at rt.cpan.org</code>, or through the web interface at <a href="http://rt.cpan.org/Public/Dist/Display.html?Name=CPAN-Reporter-Smoker">http://rt.cpan.org/Public/Dist/Display.html?Name=CPAN-Reporter-Smoker</a>. You will be automatically notified of any progress on the request by the system.</p>

<h2 id="Source-Code">Source Code</h2>

<p>This is open source software. The code repository is available for public review and contribution under the terms of the license.</p>

<p><a href="http://github.com/dagolden/cpan-reporter-smoker">http://github.com/dagolden/cpan-reporter-smoker</a></p>

<pre><code>  git clone http://github.com/dagolden/cpan-reporter-smoker</code></pre>

<h1 id="AUTHOR">AUTHOR</h1>

<p>David Golden &lt;dagolden@cpan.org&gt;</p>

<h1 id="COPYRIGHT-AND-LICENSE">COPYRIGHT AND LICENSE</h1>

<p>This software is Copyright (c) 2011 by David Golden.</p>

<p>This is free software, licensed under:</p>

<pre><code>  The Apache License, Version 2.0, January 2004</code></pre>


</body>

</html>


